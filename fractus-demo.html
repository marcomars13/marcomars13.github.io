<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fractus Demo ‚Äî Powered by Fractys</title>
  <meta name="description" content="Scientific benchmark and visual demonstration of the Fractus Algorithm ‚Äî fractal intelligence applied to AI, logs, and data patterns.">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/demo.css">
  <style>
    /* ---------- Vignette (photo + m√©ta) ---------- */
    .sample-viewer {
      max-width: 1080px; margin: 8px auto 18px; padding: 12px;
      background: rgba(10,15,15,.9); border:1px solid rgba(127,255,212,.14);
      border-radius: 12px; box-shadow:0 0 14px rgba(127,255,212,.08);
      display: grid; grid-template-columns: 220px 1fr; gap: 12px; align-items: center;
    }
    .sample-thumb {
      width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 10px;
      border:1px solid rgba(127,255,212,.18); box-shadow:0 0 12px rgba(127,255,212,.10);
      background: radial-gradient(120% 80% at 50% 50%, rgba(127,255,212,.06), rgba(0,0,0,.9));
    }
    .thumb-fallback {
      display:flex; align-items:center; justify-content:center;
      width:100%; aspect-ratio:4/3; border-radius:10px;
      border:1px solid rgba(127,255,212,.18); color:#9fffe0;
      font-family:ui-monospace,monospace;
      background: repeating-linear-gradient(45deg, rgba(127,255,212,.06) 0 12px, rgba(0,0,0,.9) 12px 24px);
    }
    .sample-meta {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
      gap:8px; color:#9fffe0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem;
    }
    .badge { display:inline-flex; gap:6px; align-items:center; padding:4px 8px;
      border:1px solid rgba(127,255,212,.22); border-radius:8px; color:#9fffe0; background: rgba(10,15,15,.88); }
    .muted { color:#7fbfb0; }

    /* ---------- Disposition centrale (4 cartes autour de la roue) ---------- */
    .fractus-lab-center { padding: 32px 0 42px; }
    .fractus-grid-core {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, auto);
      gap: 24px;
      align-items: center;
      justify-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    .engine-core {
      grid-row: 2;
      grid-column: 2;
      background: radial-gradient(circle at center, rgba(0,255,180,0.05), rgba(0,0,0,1) 80%);
      border-radius: 18px;
      box-shadow: 0 0 35px rgba(127,255,212,0.12);
      padding: 18px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .engine-core canvas {
      width: 100%; max-width: 520px; height: 350px;
      border-radius: 14px; border: 1px solid rgba(127,255,212,0.2);
    }
    #card-error     { grid-row: 1; grid-column: 1; }
    #card-entropy   { grid-row: 1; grid-column: 3; }
    #card-stability { grid-row: 3; grid-column: 1; }
    #card-eff       { grid-row: 3; grid-column: 3; }
    .lab-card { width: 100%; max-width: 340px; text-align: left; }
    .live-monitor {
      margin-top: 10px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px;
      font-family: ui-monospace, monospace; font-size: 0.9rem; color: #9fffe0; width: 100%;
      background: rgba(0,0,0,0.3); border: 1px solid rgba(127,255,212,0.12); border-radius: 8px; padding: 6px;
    }
    @media (max-width: 900px) {
      .fractus-grid-core { grid-template-columns: 1fr; grid-template-rows: auto; }
      .engine-core { grid-row: auto; grid-column: auto; }
    }
  </style>
</head>

<body class="fractus-access">
  <nav>
    <div class="brand">
      <img src="/logo.png" alt="Fractys logo"/>
      <span>Fractys (FTS)</span>
    </div>
    <div class="links">
      <a href="/index.html">Home</a>
      <a href="/fractus-access.html">Fractus Access</a>
      <a href="/airdrop.html">Airdrop</a>
      <a href="/fractus-demo.html" class="active">Demo</a>
    </div>
  </nav>

  <header class="demo-hero">
    <div class="hero-inner">
      <h1>üß† Fractus Scientific Demo</h1>
      <p class="subtitle">Per-image live benchmark ‚Äî Mapillary 5k (500-frame loop, 2 s / frame)</p>
    </div>
  </header>

  <main class="demo-container">

    <!-- ===== VIGNETTE (photo + meta) ===== -->
    <section class="lab-section">
      <div class="sample-viewer">
        <div>
          <img id="mapiImg" class="sample-thumb" alt="Mapillary sample" />
          <div id="thumbFallback" class="thumb-fallback" style="display:none;">image unavailable</div>
        </div>
        <div class="sample-meta">
          <div class="badge">üñºÔ∏è <span id="metaFilename">‚Äî</span></div>
          <div>üìç GT: <span id="metaGT" class="muted">‚Äî</span></div>
          <div>ü™™ Plonk err: <span id="metaPlonkErr">‚Äî</span></div>
          <div>üß¨ Fractus err: <span id="metaFracErr">‚Äî</span></div>
          <div>‚è±Ô∏è Frame: <span id="metaFrame">0 / 500</span></div>
        </div>
      </div>
    </section>

    <!-- ===== BLOC CENTRAL : 4 cartes autour de la roue ===== -->
    <section class="fractus-lab-center">
      <h2 class="lab-title">‚ö° Fractus Engine ‚Äî Real-Time Stability Monitor</h2>

      <div class="fractus-grid-core">

        <!-- Haut gauche -->
        <div class="lab-card" id="card-error">
          <h4>Average Error (km)</h4>
          <div class="lab-meta">Plonk vs Fractus (per image)</div>
          <canvas id="c_bench" class="lab-canvas"></canvas>
          <div class="lab-legend">
            <div>Plonk: <span class="val" id="lg_plonk">‚Äî</span></div>
            <div>Fractus: <span class="val" id="lg_fractus">‚Äî</span></div>
            <div>Gain: <span class="val" id="lg_gain">‚Äî</span></div>
          </div>
        </div>

        <!-- Haut droite -->
        <div class="lab-card" id="card-entropy">
          <h4>Entropy & Coherence</h4>
          <div class="lab-meta">Derived from stability window</div>
          <canvas id="c_entropy" class="lab-canvas"></canvas>
          <div class="lab-legend">
            <div>Entropy: <span class="val" id="co_entropy">‚Äî</span></div>
            <div>Coherence: <span class="val" id="co_coherence">‚Äî</span></div>
          </div>
        </div>

        <!-- Centre (roue) -->
        <div class="engine-core">
          <canvas id="fractusCanvas"></canvas>
          <div class="live-monitor">
            <div>üåÄ Entropy: <span id="m_entropy">‚Äî</span></div>
            <div>üîó Coherence: <span id="m_coherence">‚Äî</span></div>
            <div>‚ö° Efficiency: <span id="m_efficiency">‚Äî</span></div>
            <div>üìà Stability: <span id="m_stability">‚Äî</span></div>
          </div>
        </div>

        <!-- Bas gauche -->
        <div class="lab-card" id="card-stability">
          <h4>Fractal Stability ‚Äî Std Dev (km)</h4>
          <div class="lab-meta">Rolling window (60)</div>
          <canvas id="c_stability" class="lab-canvas"></canvas>
          <div class="lab-legend">
            <div>Plonk œÉ: <span class="val" id="sigmaPlonk">‚Äî</span></div>
            <div>Fractus œÉ: <span class="val" id="stabilityVal">‚Äî</span></div>
          </div>
        </div>

        <!-- Bas droite -->
        <div class="lab-card" id="card-eff">
          <h4>Processing Efficiency</h4>
          <div class="lab-meta">Relative accuracy ratio</div>
          <canvas id="c_eff" class="lab-canvas"></canvas>
          <div class="lab-legend">
            <div>Efficiency: <span class="val" id="efficiencyVal">‚Äî</span></div>
            <div>Status: <span class="val" id="statusVal">Live (2 s)</span></div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== LOGS (inchang√©) ===== -->
    <section class="lab-section">
      <h2 class="lab-title">Benchmark Logs ‚Äî Anomaly Detection on 50 000 Entries</h2>
      <div class="lab-grid">
        <div class="lab-card"><h4>Detection Rate (%)</h4><canvas id="c_log_rate" class="lab-canvas"></canvas></div>
        <div class="lab-card"><h4>False Positive Rate (%)</h4><canvas id="c_log_fp" class="lab-canvas"></canvas></div>
        <div class="lab-card"><h4>Mean Detection Latency (ms)</h4><canvas id="c_log_latency" class="lab-canvas"></canvas></div>
        <div class="lab-card"><h4>Accuracy / Throughput</h4><canvas id="c_log_acc" class="lab-canvas"></canvas></div>
      </div>
    </section>

  </main>

  <footer>¬© 2025 Fractys ‚Äî Created by Marc Cedrych ‚Äî Built on Solana</footer>

  <!-- ==================== JS EMBARQU√â (aucun 404 possible) ==================== -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    /* ------------ Utils & canvas ------------ */
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const lerp=(a,b,t)=>a+(b-a)*t;
    function prepCanvas(c,w,h){
      const dpr = (window.devicePixelRatio || 1);
      const cssW = (w != null ? w : (c.clientWidth || 300));
      const cssH = (h != null ? h : (c.clientHeight || 150));
      c.width = Math.max(1, Math.floor(cssW * dpr));
      c.height = Math.max(1, Math.floor(cssH * dpr));
      const ctx = c.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return { ctx, cssW, cssH };
    }

    /* ------------ √âtat global ------------ */
    const RAW_URL='https://raw.githubusercontent.com/marcomars13/fractus-ia/main/results/bench_compare_5000.csv';
    const LOOP_COUNT=500;   // 500 frames
    const FRAME_MS=2000;    // 2 s
    const STAB_WIN=60;

    const METRICS={entropy:0.032, coherence:98.4, efficiency:1.30, stability:90.6};
    const BENCH={plonk_km:0, fractus_km:0};
    const SIGMA={plonk:0, fractus:0};
    const qPlonk=[], qFrac=[];

    /* ------------ DOM refs ------------ */
    const lg_plonk      = document.getElementById('lg_plonk');
    const lg_fractus    = document.getElementById('lg_fractus');
    const lg_gain       = document.getElementById('lg_gain');
    const sigmaPlonk    = document.getElementById('sigmaPlonk');
    const stabilityVal  = document.getElementById('stabilityVal');
    const entOut        = document.getElementById('co_entropy');
    const cohOut        = document.getElementById('co_coherence');
    const efficiencyVal = document.getElementById('efficiencyVal');
    const statusVal     = document.getElementById('statusVal');

    const m_entropy     = document.getElementById('m_entropy');
    const m_coherence   = document.getElementById('m_coherence');
    const m_efficiency  = document.getElementById('m_efficiency');
    const m_stability   = document.getElementById('m_stability');

    const metaFilename  = document.getElementById('metaFilename');
    const metaGT        = document.getElementById('metaGT');
    const metaPlonkErr  = document.getElementById('metaPlonkErr');
    const metaFracErr   = document.getElementById('metaFracErr');
    const metaFrame     = document.getElementById('metaFrame');

    /* ------------ Vignette Mapillary (fallback si indisponible) ------------ */
    function updateThumb(filename, gtLat, gtLon, idx){
      const id = filename.replace(/\.jpg$/i,'');
      const candidates = [
        `https://images.mapillary.com/${id}/thumb-1024.jpg`,
      ];
      const img = document.getElementById('mapiImg');
      const fb  = document.getElementById('thumbFallback');
      let p=0; img.style.display=''; fb.style.display='none';
      function tryNext(){ if(p>=candidates.length){ img.style.display='none'; fb.style.display='flex'; return; }
        img.src = candidates[p++]; }
      img.onerror = tryNext; tryNext();

      metaFilename.textContent = filename;
      metaGT.textContent = `${gtLat.toFixed(5)}, ${gtLon.toFixed(5)}`;
      metaFrame.textContent = `${idx+1} / ${LOOP_COUNT}`;
    }

    /* ------------ Widgets (animations continues) ------------ */
    function benchWidget(id){
      const c = document.getElementById(id); if(!c) return ()=>{};
      let g=prepCanvas(c); window.addEventListener('resize',()=>g=prepCanvas(c));
      let a=0,b=0;
      return function draw(){
        const {ctx,cssW,cssH}=g; ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle='#0b0f10'; ctx.fillRect(0,0,cssW,cssH);
        a = lerp(a || BENCH.fractus_km, BENCH.fractus_km, 0.15);
        b = lerp(b || BENCH.plonk_km  , BENCH.plonk_km  , 0.15);
        const max=Math.max(a,b,1)*1.15, pad=12, y=cssH*0.62;
        ctx.fillStyle='rgba(255,80,80,0.85)'; ctx.fillRect(pad,y,(b/max)*(cssW-pad*2),20);
        ctx.fillStyle='rgba(127,255,212,0.9)'; ctx.fillRect(pad,y-30,(a/max)*(cssW-pad*2),20);
        ctx.fillStyle='#9adfce'; ctx.font='12px ui-sans-serif';
        ctx.fillText(`Fractus: ${BENCH.fractus_km.toFixed(1)} km`, pad, y-12);
        ctx.fillText(`Plonk: ${BENCH.plonk_km.toFixed(1)} km`, pad, y+35);
      };
    }
    function entropyWidget(id){
      const c=document.getElementById(id); if(!c) return ()=>{};
      let g=prepCanvas(c); window.addEventListener('resize',()=>g=prepCanvas(c));
      return function draw(now){
        const {ctx,cssW,cssH}=g; ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle='#0b0f10'; ctx.fillRect(0,0,cssW,cssH);
        ctx.strokeStyle='rgba(127,255,212,0.08)'; ctx.beginPath();
        for(let x=0;x<cssW;x+=Math.max(16,cssW/20)){ ctx.moveTo(x,8); ctx.lineTo(x,cssH-8); }
        for(let y=0;y<cssH;y+=Math.max(16,cssH/10)){ ctx.moveTo(8,y); ctx.lineTo(cssW-8,y); }
        ctx.stroke();
        const up=(METRICS.entropy-0.028)/(0.045-0.028);
        ctx.strokeStyle='rgba(127,200,255,0.9)'; ctx.lineWidth=1.6; ctx.beginPath();
        for(let x=0;x<cssW;x++){
          const t=(x/cssW)*6.283 + (now||performance.now())*0.0035;
          const y=cssH*0.30 + Math.sin(t)*8*(0.6+up) + Math.sin(t*0.7+1.3)*3;
          x?ctx.lineTo(x+8,y):ctx.moveTo(x+8,y);
        } ctx.stroke();
        ctx.strokeStyle='rgba(127,255,212,0.9)'; ctx.beginPath();
        for(let x=0;x<cssW;x++){
          const t=(x/cssW)*6.283 + (now||performance.now())*0.0025;
          const y=cssH*0.72 + Math.sin(t)*4 + Math.sin(t*1.3+0.6)*1.5;
          x?ctx.lineTo(x+8,y):ctx.moveTo(x+8,y);
        } ctx.stroke();
      };
    }
    function stabilityWidget(id){
      const c=document.getElementById(id); if(!c) return ()=>{};
      let g=prepCanvas(c); window.addEventListener('resize',()=>g=prepCanvas(c));
      return function draw(){
        const {ctx,cssW,cssH}=g; ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle='#0b0f10'; ctx.fillRect(0,0,cssW,cssH);
        const mu=cssW*0.55;
        ctx.beginPath();
        for(let x=0;x<cssW;x++){
          const km=(x-mu)/(cssW/160);
          const y=Math.exp(-(km*km)/(2*(METRICS.stability*METRICS.stability+1e-6)));
          const yy=cssH-10 - y*(cssH*0.65);
          x?ctx.lineTo(x,yy):ctx.moveTo(x,yy);
        }
        ctx.strokeStyle='rgba(127,255,212,0.85)'; ctx.lineWidth=2; ctx.stroke();
        ctx.setLineDash([4,4]); ctx.strokeStyle='rgba(255,255,255,0.18)';
        ctx.beginPath(); ctx.moveTo(mu,10); ctx.lineTo(mu,cssH-10); ctx.stroke(); ctx.setLineDash([]);
      };
    }
    function effWidget(id){
      const c=document.getElementById(id); if(!c) return ()=>{};
      let g=prepCanvas(c); window.addEventListener('resize',()=>g=prepCanvas(c));
      return function draw(now){
        const {ctx,cssW,cssH}=g; ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle='#0b0f10'; ctx.fillRect(0,0,cssW,cssH);
        const r=Math.min(cssW,cssH)*0.32, cx=cssW*0.18+r+10, cy=cssH*0.52;
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='rgba(127,255,212,0.12)'; ctx.lineWidth=10; ctx.stroke();
        const v=clamp(METRICS.efficiency,0.6,2.0); const a0=-Math.PI*0.75; const a1=a0 + (v-0.6)/1.4*(Math.PI*1.5);
        ctx.beginPath(); ctx.arc(cx,cy,r,a0,a1); ctx.strokeStyle='rgba(127,255,212,0.9)'; ctx.lineWidth=10; ctx.stroke();
        const tick=a0 + ((now||performance.now())*0.002 % (Math.PI*1.5));
        ctx.beginPath(); ctx.arc(cx,cy,r,tick-0.05,tick+0.05);
        ctx.strokeStyle='rgba(255,255,255,0.35)'; ctx.lineWidth=10; ctx.stroke();
        ctx.fillStyle='#9adfce'; ctx.font='12px ui-sans-serif'; ctx.fillText(`√ó ${v.toFixed(2)} efficiency`, cx+r+18, cy+4);
      };
    }
    const widgets=[
      benchWidget('c_bench'),
      entropyWidget('c_entropy'),
      stabilityWidget('c_stability'),
      effWidget('c_eff')
    ].filter(Boolean);
    (function loop(){
      for(const w of widgets) w();
      requestAnimationFrame(loop);
    })();

    /* ------------ Roue fractale ------------ */
    const wheel=document.getElementById("fractusCanvas");
    let fctx, fw, fh;
    function initWheel(){ const r=prepCanvas(wheel, Math.min(window.innerWidth*0.9,720), 400); fctx=r.ctx; fw=r.cssW; fh=r.cssH; }
    window.addEventListener("resize",initWheel); initWheel();
    (function drawWheel(){
      if(!fctx){ requestAnimationFrame(drawWheel); return; }
      fctx.clearRect(0,0,fw,fh);
      const eNorm=clamp((METRICS.entropy-0.028)/(0.045-0.028),0,1);
      const radius=50+Math.sin(performance.now()*0.003)*(8*eNorm+2);
      const grad=fctx.createRadialGradient(fw/2,fh/2,0,fw/2,fh/2,radius+80);
      grad.addColorStop(0,`rgba(127,255,212,${0.10+0.15*eNorm})`); grad.addColorStop(1,"rgba(0,0,0,0)");
      fctx.fillStyle=grad; fctx.beginPath(); fctx.arc(fw/2,fh/2,radius+80,0,Math.PI*2); fctx.fill();
      const rings=9,baseR=40,stepR=35,N=12;
      for(let i=0;i<rings;i++){ const r=baseR+i*stepR+Math.sin(performance.now()*0.002+i)*2; fctx.beginPath();
        fctx.strokeStyle=`hsl(${(i*28+performance.now()*0.02)%360},80%,70%)`; fctx.lineWidth=1.1; fctx.arc(fw/2,fh/2,r,0,Math.PI*2); fctx.stroke(); }
      const speed=0.6 + eNorm*0.8;
      for(let i=0;i<N;i++){
        const a=performance.now()*0.001*speed+i*0.52; const r=baseR+(i%(rings-2))*stepR;
        const x=fw/2+Math.cos(a)*r, y=fh/2+Math.sin(a)*r;
        fctx.beginPath(); fctx.fillStyle=i%3===0?'#7fffd4':(i%3===1?'#80c0ff':'#ffe680'); fctx.arc(x,y,3,0,Math.PI*2); fctx.fill();
      }
      requestAnimationFrame(drawWheel);
    })();

    /* ------------ Logs (placeholder anim) ------------ */
    function miniBar(id){
      const c=document.getElementById(id); if(!c)return;
      let g=prepCanvas(c); window.addEventListener('resize',()=>g=prepCanvas(c));
      (function draw(){ const {ctx,cssW,cssH}=g; ctx.clearRect(0,0,cssW,cssH); ctx.fillStyle='#0b0f10'; ctx.fillRect(0,0,cssW,cssH);
        const pad=12, a=97+Math.sin(performance.now()*0.0009)*1.0, b=95+Math.cos(performance.now()*0.0008)*1.0;
        const max=Math.max(a,b)*1.15;
        ctx.fillStyle='rgba(255,80,80,0.85)'; ctx.fillRect(pad,cssH*0.62,(b/max)*(cssW-pad*2),20);
        ctx.fillStyle='rgba(127,255,212,0.9)'; ctx.fillRect(pad,cssH*0.62-30,(a/max)*(cssW-pad*2),20);
        requestAnimationFrame(draw);
      })();
    }
    miniBar('c_log_rate'); miniBar('c_log_fp'); miniBar('c_log_latency'); miniBar('c_log_acc');

    /* ------------ Chargement 500 lignes + boucle 2 s ------------ */
    async function loadFirst500(url){
      const res = await fetch(url, { cache:'no-store' });
      const txt = await res.text();
      const rows = txt.trim().split('\n'); rows.shift();
      return rows.slice(0, LOOP_COUNT).map(line=>{
        const c=line.split(',');
        return {
          filename: c[0],
          gt_lat: parseFloat(c[1]), gt_lon: parseFloat(c[2]),
          plonk_error_km: parseFloat(c[5]),
          fractus_error_km: parseFloat(c[8]),
        };
      }).filter(r=>Number.isFinite(r.plonk_error_km)&&Number.isFinite(r.fractus_error_km));
    }
    function writePerImage(){
      if(lg_plonk)   lg_plonk.textContent   = `${BENCH.plonk_km.toFixed(1)} km`;
      if(lg_fractus) lg_fractus.textContent = `${BENCH.fractus_km.toFixed(1)} km`;
      const gain=(BENCH.plonk_km - BENCH.fractus_km)/Math.max(1e-9,BENCH.plonk_km)*100;
      if(lg_gain){ lg_gain.textContent = `${gain<0?'‚àí':''}${Math.abs(gain).toFixed(1)} %`; lg_gain.style.color = gain>0?'#7fffd4':'#ffe680'; }
      if(sigmaPlonk)   sigmaPlonk.textContent   = `${SIGMA.plonk.toFixed(1)} km`;
      if(stabilityVal) stabilityVal.textContent = `${SIGMA.fractus.toFixed(1)} km`;
      if(entOut)   entOut.textContent   = METRICS.entropy.toFixed(3);
      if(cohOut)   cohOut.textContent   = `${METRICS.coherence.toFixed(1)} %`;
      if(efficiencyVal)efficiencyVal.textContent= `√ó ${METRICS.efficiency.toFixed(2)}`;
      if(m_entropy)  m_entropy.textContent  = METRICS.entropy.toFixed(3);
      if(m_coherence)m_coherence.textContent= `${METRICS.coherence.toFixed(1)} %`;
      if(m_efficiency)m_efficiency.textContent= `√ó ${METRICS.efficiency.toFixed(2)}`;
      if(m_stability)m_stability.textContent= `œÉ = ${METRICS.stability.toFixed(1)} km`;
      if(metaPlonkErr) metaPlonkErr.textContent = `${BENCH.plonk_km.toFixed(2)} km`;
      if(metaFracErr)  metaFracErr.textContent  = `${BENCH.fractus_km.toFixed(2)} km`;
    }
    function updateFromRow(r, idx){
      BENCH.plonk_km   = r.plonk_error_km;
      BENCH.fractus_km = r.fractus_error_km;
      METRICS.efficiency = clamp(BENCH.plonk_km/Math.max(1e-9,BENCH.fractus_km), 0.6, 2.0);
      qPlonk.push(BENCH.plonk_km);  if(qPlonk.length>STAB_WIN) qPlonk.shift();
      qFrac .push(BENCH.fractus_km);if(qFrac.length>STAB_WIN)  qFrac.shift();
      const std = a => { const n=a.length; if(n<2) return 0; const m=a.reduce((x,y)=>x+y,0)/n;
        const v=a.reduce((s,y)=>s+(y-m)*(y-m),0)/(n-1); return Math.sqrt(v); };
      SIGMA.plonk   = std(qPlonk);
      SIGMA.fractus = std(qFrac);
      METRICS.stability = SIGMA.fractus;
      const e = clamp(0.028 + (METRICS.stability-90)/(91-90+1e-9) * 0.017, 0.028, 0.045);
      METRICS.entropy   = e;
      METRICS.coherence = clamp(99 - (e-0.028)/(0.045-0.028)*2.0, 97.0, 99.0);
      updateThumb(r.filename, r.gt_lat, r.gt_lon, idx);
      writePerImage();
    }
    (async function start(){
      try{
        const sample = await loadFirst500(RAW_URL);
        if(!sample.length){ if(statusVal) statusVal.textContent='No data'; return; }
        let i=0; updateFromRow(sample[i], i);
        setInterval(()=>{ i=(i+1)%sample.length; updateFromRow(sample[i], i); }, FRAME_MS);
      }catch(e){ console.error(e); if(statusVal) statusVal.textContent='Load error'; }
    })();
  });
  </script>
</body>
</html>
