<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fractus Access ‚Äî Powered by Fractys</title>
  <meta name="description" content="Access the Fractus Algorithm using Fractys (FTS).">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="access.css">

  <style>
    /* ---------- STYLE FRACTAL ---------- */
    .icon-fractal {
      color: var(--accent);
      filter: drop-shadow(0 0 8px rgba(127,255,212,0.6))
              drop-shadow(0 0 16px rgba(127,255,212,0.4))
              drop-shadow(0 0 30px rgba(127,255,212,0.25));
      animation: iconPulse 5s ease-in-out infinite;
    }

    @keyframes iconPulse {
      0%, 100% { filter: drop-shadow(0 0 8px rgba(127,255,212,0.5)); }
      50% { filter: drop-shadow(0 0 20px rgba(127,255,212,1)); }
    }

    /* Zone d‚Äôaffichage des messages */
    #status-box {
      margin-top: 30px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(0,0,0,0.5);
      color: var(--accent, #7fffd4);
      font-family: monospace;
      text-align: center;
      white-space: pre-line;
      box-shadow: 0 0 20px rgba(127,255,212,0.4);
      display: none;
      transition: all 0.3s ease;
    }

    /* Bouton de connexion wallet */
    #connect-btn {
      background: rgba(127,255,212,0.08);
      border: 1px solid rgba(127,255,212,0.4);
      color: var(--accent, #7fffd4);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 20px;
    }
    #connect-btn:hover { background: rgba(127,255,212,0.25); }
  </style>
</head>

<body class="fractus-access">

  <!-- ================= NAVIGATION ================= -->
  <nav>
    <div class="brand">
      <img src="logo.png" alt="Fractys logo"/>
      <span>Fractys (FTS)</span>
    </div>
    <div class="links">
      <a href="index.html">Home</a>
      <a href="airdrop.html">Airdrop</a>
      <a href="fractus-access.html" class="active">Fractus Access</a>
    </div>
  </nav>

  <!-- ================= CONTENU PRINCIPAL ================= -->
  <main class="container">

    <!-- ----- INTRO ----- -->
    <div class="access-header">
      <h1><span class="icon-fractal">üåÄ</span> Fractus Access</h1>
      <p>
        Access the <strong>Fractus Algorithm</strong> ‚Äî a fractal engine merging AI, mathematics, and blockchain validation ‚Äî
        using your <strong>Fractys (FTS)</strong> tokens.<br>
        Choose your license tier below to unlock your level of exploration.
      </p>
    </div>

    <!-- ----- BOUTON CONNEXION WALLET ----- -->
    <div style="text-align:center;">
      <button id="connect-btn">üîó Connect Wallet (Phantom)</button>
    </div>

    <!-- ----- OFFRES ----- -->
    <div class="license-grid">
      <div class="card license-card" data-amount="50">
        <h2>Trial Access</h2>
        <p>24 hours of full access. 1 dataset or image sequence.</p>
        <div class="price">50 FTS</div>
        <a href="#" class="btn glow pay-btn">üí† Pay & Activate</a>
      </div>

      <div class="card license-card" data-amount="200">
        <h2>Research License</h2>
        <p>30 days, up to 10 analyses per month. Academic use.</p>
        <div class="price">200 FTS</div>
        <a href="#" class="btn glow pay-btn">üí† Pay & Activate</a>
      </div>

      <div class="card license-card" data-amount="1000">
        <h2>Professional License</h2>
        <p>1 year of Pro API access with premium support.</p>
        <div class="price">1000 FTS</div>
        <a href="#" class="btn glow pay-btn">üí† Pay & Activate</a>
      </div>
    </div>

    <!-- ----- MESSAGE BOX ----- -->
    <div id="status-box"></div>

    <!-- ----- FOOTER INFO ----- -->
    <div class="license-footer">
      <span class="icon-fractal">üí†</span> Only <strong>15,000 FTS</strong> exist.<br>
      Each transaction fuels open research and strengthens the network.<br><br>
      <small>Payments are executed directly on Solana Mainnet using the FTS token.</small>
    </div>

  </main>

  <footer>
    ¬© 2025 Fractys ‚Äî Created by Marc Cedrych ‚Äî Built on Solana
  </footer>

  <!-- ================= DEPENDANCES JS ================= -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.8/dist/browser/index.iife.min.js"></script>

  <script>
  (async ()=>{
    // ===========================================================
    // CONFIGURATION PRINCIPALE
    // ===========================================================
    const TOKEN_MINT = "BMAT7DrBHBEqxm8vxUwcYaKjKBdvGEM2uLH3XuztFawy"; // mint officiel FTS
    const NETWORK = "mainnet-beta"; // r√©seau de production Solana
    const RPC_URL = "https://api.mainnet-beta.solana.com"; // endpoint RPC public
    const POOL_WALLET = "AujPwkfvposKUN31mMZMKa8tQrPcyRGdLHnuFHhoVGje"; // ton pool wallet
    const API_URL = "https://spontaneously-exorbitant-hye.ngrok-free.dev/api/payment_split"; // backend Fractus local API

    // ===========================================================
    // LIBS SOLANA
    // ===========================================================
    const { Connection, PublicKey, Transaction, clusterApiUrl } = solanaWeb3;
    const spl = window.splToken;
    const connection = new Connection(RPC_URL, "confirmed");

    // ===========================================================
    // VARIABLES
    // ===========================================================
    const statusBox = document.getElementById('status-box');
    const connectBtn = document.getElementById('connect-btn');
    let walletPubkey = null;

    // ===========================================================
    // FONCTIONS UTILITAIRES
    // ===========================================================
    function showStatus(message, color="#7fffd4") {
      statusBox.style.display = "block";
      statusBox.style.color = color;
      statusBox.textContent = message;
    }

    async function ensurePhantom() {
      if (!window.solana || !window.solana.isPhantom) {
        alert("Phantom Wallet not found. Please install it: https://phantom.app");
        throw new Error("Phantom not installed");
      }
    }

    // ===========================================================
    // CONNEXION DU WALLET PHANTOM
    // ===========================================================
    connectBtn.addEventListener("click", async ()=>{
      try {
        await ensurePhantom();
        const resp = await window.solana.connect();
        walletPubkey = resp.publicKey;
        connectBtn.textContent = "‚úÖ Connected: " + walletPubkey.toString().slice(0,6) + "...";
        connectBtn.disabled = true;
        showStatus("Wallet connected: " + walletPubkey.toString());
      } catch (err) {
        console.error(err);
        showStatus("Connection failed: " + err.message, "#ff5555");
      }
    });

    // ===========================================================
    // TRANSFERT SPL TOKEN (FTS)
    // ===========================================================
    async function sendFTS(amountFTS) {
      if (!walletPubkey) throw new Error("Wallet not connected");

      const mintPubkey = new PublicKey(TOKEN_MINT);
      const receiverPubkey = new PublicKey(POOL_WALLET);

      // R√©cup√©ration ou cr√©ation du compte associ√©
      const senderATA = await spl.getAssociatedTokenAddress(mintPubkey, walletPubkey);
      const receiverATA = await spl.getAssociatedTokenAddress(mintPubkey, receiverPubkey);

      const tx = new Transaction();

      // Si le compte ATA du receveur n'existe pas ‚Üí le cr√©er
      const receiverInfo = await connection.getAccountInfo(receiverATA);
      if (!receiverInfo) {
        tx.add(
          spl.createAssociatedTokenAccountInstruction(
            walletPubkey, receiverATA, receiverPubkey, mintPubkey
          )
        );
      }

      // Ajout de l‚Äôinstruction de transfert
      const decimals = 9; // la plupart des SPL tokens ont 9 d√©cimales
      const amountRaw = BigInt(amountFTS * (10 ** decimals));

      tx.add(
        spl.createTransferInstruction(
          senderATA, receiverATA, walletPubkey, amountRaw
        )
      );

      // Pr√©paration de la transaction
      const { blockhash } = await connection.getLatestBlockhash("finalized");
      tx.recentBlockhash = blockhash;
      tx.feePayer = walletPubkey;

      // Signature Phantom
      const signedTx = await window.solana.signTransaction(tx);
      const signature = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(signature, "confirmed");

      return signature;
    }

    // ===========================================================
    // PAIEMENT : CLICK SUR "PAY & ACTIVATE"
    // ===========================================================
    document.querySelectorAll(".pay-btn").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.preventDefault();
        try { await ensurePhantom(); } catch { return; }
        if (!walletPubkey) { alert("Connect your wallet first."); return; }

        const card = e.target.closest(".card");
        const amount = Number(card.dataset.amount);
        showStatus(`‚è≥ Sending ${amount} FTS... please approve in Phantom.`);

        try {
          // 1Ô∏è‚É£ Envoi r√©el du token
          const txSig = await sendFTS(amount);
          showStatus(`‚úÖ Transaction sent!\nTX: ${txSig}\nRecording in ledger...`);

          // 2Ô∏è‚É£ Enregistrement backend ledger
          const res = await fetch(`${API_URL}?fts_amount=${amount}&wallet=${walletPubkey.toString()}&tx=${txSig}`, { method: 'POST' });
          const data = await res.json();

          if (data.success) {
            showStatus(
`‚úÖ Payment confirmed
üí∞ Amount: ${data.fts_spent} FTS
üåÄ Pool: ${data.distribution.pool} FTS
üë§ Main: ${data.distribution.main} FTS
üè¶ Treasury: ${data.distribution.treasury} FTS

TX: ${txSig}
Recorded: ${data.timestamp}`
            );
          } else {
            showStatus("‚ö†Ô∏è On-chain success but ledger update failed.", "#ffcc55");
          }
        } catch (err) {
          console.error(err);
          showStatus("‚ùå Payment failed: " + (err.message || err), "#ff5555");
        }
      });
    });

  })();
  </script>
</body>
</html>
